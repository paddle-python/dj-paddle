<div id="csrf">{% csrf_token %}</div>
<script type="text/javascript">

function checkoutComplete(data) {
    var csrftoken = document.getElementById("csrf").getElementsByTagName("input")[0].value;

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "{% url 'djpaddle:post_checkout_api' %}");
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.setRequestHeader("X-CSRFToken", csrftoken);

    var email = '';
    if (data.hasOwnProperty('user') && data.user !== null){
        email = data.user.email;
    }
    var postData = {
        id: data.checkout.id,
        completed: data.checkout.completed,
        passthrough: data.checkout.passthrough,
        email: email,
        created_at: data.checkout.created_at,
    };
    var encodedString = buildFormData(postData);

    xhr.send(encodedString);
}

function buildFormData(data) {
    var encodedString = '';
    for (var prop in data) {
        if (data.hasOwnProperty(prop)) {
            if (encodedString.length > 0) {
                encodedString += '&';
            }
            encodedString += encodeURI(prop + '=' + data[prop]);
        }
    }
    return encodedString;
}

function addCheckoutCompleteToPaddleButtons() {
    paddleButtons = document.getElementsByClassName("paddle_button");
    for (var k in paddleButtons) {
        if (paddleButtons.hasOwnProperty(k)) {
            paddleButtons[k].setAttribute("data-success-callback", "checkoutComplete");
        }
    }
}

document.addEventListener("DOMContentLoaded", function(event) {
    addCheckoutCompleteToPaddleButtons()
});
</script>
